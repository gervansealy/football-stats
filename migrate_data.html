<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Data Migration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #e74c3c;
            margin-bottom: 10px;
        }
        textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 15px 0;
        }
        button {
            background: #e74c3c;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        button:hover {
            background: #c0392b;
        }
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .instructions {
            background: #fff3cd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
        }
        .instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        .instructions li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• Firebase Data Migration Tool</h1>
        <p>This tool will migrate your localStorage data to Firebase Firestore.</p>
        
        <div class="instructions">
            <strong>üìã Instructions:</strong>
            <ol>
                <li>Paste your copied data in the textarea below</li>
                <li>Click "Migrate to Firebase"</li>
                <li>Wait for success message</li>
                <li>Close this page and open your main database</li>
            </ol>
            <p><strong>‚ö†Ô∏è Note:</strong> Firebase has a 1 MB document size limit. This tool will automatically remove Base64-encoded images/videos (too large) but keep all player stats, games, and settings.</p>
        </div>

        <label for="dataInput"><strong>Paste your localStorage data here:</strong></label>
        <textarea id="dataInput" placeholder='{"players":[...],"games":[...],"pointValues":{...},"accessPasswords":{...}}'></textarea>

        <button id="migrateBtn" onclick="migrateData()">üöÄ Migrate to Firebase</button>

        <div id="status" class="status"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration - SAME AS YOUR MAIN APP
        const firebaseConfig = {
            apiKey: "AIzaSyB_Wa0KwcGyKPDvycYwyWCS4OKaCImejcw",
            authDomain: "football-stats-cf534.firebaseapp.com",
            projectId: "football-stats-cf534",
            storageBucket: "football-stats-cf534.firebasestorage.app",
            messagingSenderId: "876750360073",
            appId: "1:876750360073:web:f75c6803743bd026e8f2d8",
            measurementId: "G-E3W8VZEJ7Q"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.migrateData = async function() {
            const dataInput = document.getElementById('dataInput');
            const statusDiv = document.getElementById('status');
            const migrateBtn = document.getElementById('migrateBtn');

            try {
                // Parse input
                const data = JSON.parse(dataInput.value.trim());

                // Show processing status
                statusDiv.className = 'status info';
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = '‚è≥ Cleaning data and migrating to Firebase... Please wait.';
                migrateBtn.disabled = true;

                // Deep clean function to remove problematic data
                function cleanForFirestore(obj) {
                    if (obj === null || obj === undefined) return null;
                    if (typeof obj !== 'object') return obj;
                    
                    if (Array.isArray(obj)) {
                        return obj.map(item => cleanForFirestore(item)).filter(item => item !== null && item !== undefined);
                    }
                    
                    const cleaned = {};
                    for (const key in obj) {
                        const value = obj[key];
                        
                        // Skip functions
                        if (typeof value === 'function') continue;
                        
                        // Skip undefined
                        if (value === undefined) continue;
                        
                        // Convert null to empty string for strings
                        if (value === null) {
                            cleaned[key] = null;
                            continue;
                        }
                        
                        // Recursively clean objects and arrays
                        cleaned[key] = cleanForFirestore(value);
                    }
                    return cleaned;
                }

                // Clean players data (remove large Base64 images/videos)
                let removedHeadshots = 0;
                let removedHighlights = 0;
                
                if (data.players) {
                    data.players = data.players.map(player => {
                        // Deep clone and clean
                        let cleanPlayer = cleanForFirestore(player);
                        
                        // Remove headshot if it's Base64 (too large for Firestore)
                        if (cleanPlayer.headshot && typeof cleanPlayer.headshot === 'string' && cleanPlayer.headshot.startsWith('data:')) {
                            cleanPlayer.headshot = null;
                            removedHeadshots++;
                        }
                        
                        // Clean highlights array
                        if (cleanPlayer.highlights && Array.isArray(cleanPlayer.highlights)) {
                            cleanPlayer.highlights = cleanPlayer.highlights.map(h => {
                                if (!h || typeof h !== 'object') return null;
                                
                                // Remove Base64 videos
                                if (h.url && typeof h.url === 'string' && h.url.startsWith('data:')) {
                                    removedHighlights++;
                                    return null;
                                }
                                
                                // Return only simple object
                                return {
                                    title: h.title || '',
                                    url: h.url || ''
                                };
                            }).filter(h => h !== null);
                        }
                        
                        // Ensure stats object is clean
                        if (cleanPlayer.stats && typeof cleanPlayer.stats === 'object') {
                            cleanPlayer.stats = {
                                gamesPlayed: Number(cleanPlayer.stats.gamesPlayed) || 0,
                                wins: Number(cleanPlayer.stats.wins) || 0,
                                draws: Number(cleanPlayer.stats.draws) || 0,
                                losses: Number(cleanPlayer.stats.losses) || 0,
                                cleanSheets: Number(cleanPlayer.stats.cleanSheets) || 0,
                                goalsScored: Number(cleanPlayer.stats.goalsScored) || 0,
                                captainWins: Number(cleanPlayer.stats.captainWins) || 0,
                                captainLosses: Number(cleanPlayer.stats.captainLosses) || 0
                            };
                        }
                        
                        return cleanPlayer;
                    });
                }
                
                // Clean games data
                if (data.games) {
                    data.games = data.games.map(game => cleanForFirestore(game));
                }

                // Migrate each data type
                const migrations = [];

                if (data.players) {
                    migrations.push(
                        setDoc(doc(db, 'footballStats', 'players'), { value: data.players })
                    );
                }

                if (data.games) {
                    migrations.push(
                        setDoc(doc(db, 'footballStats', 'games'), { value: data.games })
                    );
                }

                if (data.pointValues) {
                    migrations.push(
                        setDoc(doc(db, 'footballStats', 'pointValues'), { value: data.pointValues })
                    );
                }

                if (data.accessPasswords) {
                    migrations.push(
                        setDoc(doc(db, 'footballStats', 'accessPasswords'), { value: data.accessPasswords })
                    );
                }

                if (data.previousYearTitles) {
                    migrations.push(
                        setDoc(doc(db, 'footballStats', 'previousYearTitles'), { value: data.previousYearTitles })
                    );
                }

                if (data.userPermission) {
                    migrations.push(
                        setDoc(doc(db, 'footballStats', 'userPermission'), { value: data.userPermission })
                    );
                }

                // Execute all migrations
                await Promise.all(migrations);

                // Success!
                statusDiv.className = 'status success';
                statusDiv.innerHTML = `
                    <strong>‚úÖ Success!</strong><br>
                    Your data has been migrated to Firebase!<br><br>
                    <strong>Migrated:</strong><br>
                    ${data.players ? `‚úì ${data.players.length} players<br>` : ''}
                    ${data.games ? `‚úì ${data.games.length} games<br>` : ''}
                    ${data.pointValues ? `‚úì Point values<br>` : ''}
                    ${data.accessPasswords ? `‚úì Access passwords<br>` : ''}
                    <br>
                    ${removedHeadshots > 0 || removedHighlights > 0 ? `
                    <strong>‚ö†Ô∏è Note:</strong><br>
                    ${removedHeadshots > 0 ? `‚úó ${removedHeadshots} player headshot(s) removed (too large for Firebase)<br>` : ''}
                    ${removedHighlights > 0 ? `‚úó ${removedHighlights} MP4 highlight(s) removed (too large for Firebase)<br>` : ''}
                    <em>You can re-upload headshots in the main app. For highlights, use YouTube/Streamable URLs instead.</em><br><br>
                    ` : ''}
                    <strong>‚úÖ You can now close this page and open your main database!</strong>
                `;

            } catch (error) {
                console.error('Migration error:', error);
                console.error('Full error details:', JSON.stringify(error, null, 2));
                statusDiv.className = 'status error';
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = `
                    <strong>‚ùå Error!</strong><br>
                    ${error.message}<br><br>
                    <strong>Debugging info:</strong><br>
                    <pre style="background: #f5f5f5; padding: 10px; overflow: auto; max-height: 200px; font-size: 11px;">${JSON.stringify(error, null, 2)}</pre>
                    <br>
                    <strong>Common issues:</strong><br>
                    ‚Ä¢ Invalid JSON format (make sure you copied the entire output)<br>
                    ‚Ä¢ Firebase not connected (check your internet connection)<br>
                    ‚Ä¢ Permission denied (check Firestore rules)<br>
                    <br>
                    <strong>üí° Try this:</strong> Press F12, go to Console tab, and share any error messages you see there.
                `;
                migrateBtn.disabled = false;
            }
        };
    </script>
</body>
</html>

